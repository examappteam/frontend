{"ast":null,"code":"\"use strict\";\n/**\n * @fileoverview SIP Dialog\n */\n\n/**\n * @augments SIP\n * @class Class creating a SIP dialog.\n * @param {SIP.RTCSession} owner\n * @param {SIP.IncomingRequest|SIP.IncomingResponse} message\n * @param {Enum} type UAC / UAS\n * @param {Enum} state SIP.Dialog.C.STATUS_EARLY / SIP.Dialog.C.STATUS_CONFIRMED\n */\n\nmodule.exports = function (SIP) {\n  var RequestSender = require('./Dialog/RequestSender')(SIP);\n\n  var Dialog,\n      C = {\n    // Dialog states\n    STATUS_EARLY: 1,\n    STATUS_CONFIRMED: 2\n  }; // RFC 3261 12.1\n\n  Dialog = function Dialog(owner, message, type, state) {\n    var contact;\n    this.uac_pending_reply = false;\n    this.uas_pending_reply = false;\n\n    if (!message.hasHeader('contact')) {\n      return {\n        error: 'unable to create a Dialog without Contact header field'\n      };\n    }\n\n    if (message instanceof SIP.IncomingResponse) {\n      state = message.status_code < 200 ? C.STATUS_EARLY : C.STATUS_CONFIRMED;\n    } else {\n      // Create confirmed dialog if state is not defined\n      state = state || C.STATUS_CONFIRMED;\n    }\n\n    contact = message.parseHeader('contact'); // RFC 3261 12.1.1\n\n    if (type === 'UAS') {\n      this.id = {\n        call_id: message.call_id,\n        local_tag: message.to_tag,\n        remote_tag: message.from_tag,\n        toString: function toString() {\n          return this.call_id + this.local_tag + this.remote_tag;\n        }\n      };\n      this.state = state;\n      this.remote_seqnum = message.cseq;\n      this.local_uri = message.parseHeader('to').uri;\n      this.remote_uri = message.parseHeader('from').uri;\n      this.remote_target = contact.uri;\n      this.route_set = message.getHeaders('record-route');\n      this.invite_seqnum = message.cseq;\n      this.local_seqnum = message.cseq;\n    } // RFC 3261 12.1.2\n    else if (type === 'UAC') {\n        this.id = {\n          call_id: message.call_id,\n          local_tag: message.from_tag,\n          remote_tag: message.to_tag,\n          toString: function toString() {\n            return this.call_id + this.local_tag + this.remote_tag;\n          }\n        };\n        this.state = state;\n        this.invite_seqnum = message.cseq;\n        this.local_seqnum = message.cseq;\n        this.local_uri = message.parseHeader('from').uri;\n        this.pracked = [];\n        this.remote_uri = message.parseHeader('to').uri;\n        this.remote_target = contact.uri;\n        this.route_set = message.getHeaders('record-route').reverse(); //RENDERBODY\n\n        if (this.state === C.STATUS_EARLY && !owner.hasOffer) {\n          this.mediaHandler = owner.mediaHandlerFactory(owner);\n        }\n      }\n\n    this.logger = owner.ua.getLogger('sip.dialog', this.id.toString());\n    this.owner = owner;\n    owner.ua.dialogs[this.id.toString()] = this;\n    this.logger.log('new ' + type + ' dialog created with status ' + (this.state === C.STATUS_EARLY ? 'EARLY' : 'CONFIRMED'));\n    owner.emit('dialog', this);\n  };\n\n  Dialog.prototype = {\n    /**\n     * @param {SIP.IncomingMessage} message\n     * @param {Enum} UAC/UAS\n     */\n    update: function update(message, type) {\n      this.state = C.STATUS_CONFIRMED;\n      this.logger.log('dialog ' + this.id.toString() + '  changed to CONFIRMED state');\n\n      if (type === 'UAC') {\n        // RFC 3261 13.2.2.4\n        this.route_set = message.getHeaders('record-route').reverse();\n      }\n    },\n    terminate: function terminate() {\n      this.logger.log('dialog ' + this.id.toString() + ' deleted');\n\n      if (this.mediaHandler && this.state !== C.STATUS_CONFIRMED) {\n        this.mediaHandler.peerConnection.close();\n      }\n\n      delete this.owner.ua.dialogs[this.id.toString()];\n    },\n\n    /**\n    * @param {String} method request method\n    * @param {Object} extraHeaders extra headers\n    * @returns {SIP.OutgoingRequest}\n    */\n    // RFC 3261 12.2.1.1\n    createRequest: function createRequest(method, extraHeaders, body) {\n      var cseq, request;\n      extraHeaders = (extraHeaders || []).slice();\n\n      if (!this.local_seqnum) {\n        this.local_seqnum = Math.floor(Math.random() * 10000);\n      }\n\n      cseq = method === SIP.C.CANCEL || method === SIP.C.ACK ? this.invite_seqnum : this.local_seqnum += 1;\n      request = new SIP.OutgoingRequest(method, this.remote_target, this.owner.ua, {\n        'cseq': cseq,\n        'call_id': this.id.call_id,\n        'from_uri': this.local_uri,\n        'from_tag': this.id.local_tag,\n        'to_uri': this.remote_uri,\n        'to_tag': this.id.remote_tag,\n        'route_set': this.route_set\n      }, extraHeaders, body);\n      request.dialog = this;\n      return request;\n    },\n\n    /**\n    * @param {SIP.IncomingRequest} request\n    * @returns {Boolean}\n    */\n    // RFC 3261 12.2.2\n    checkInDialogRequest: function checkInDialogRequest(request) {\n      var self = this;\n\n      if (!this.remote_seqnum) {\n        this.remote_seqnum = request.cseq;\n      } else if (request.cseq < this.remote_seqnum) {\n        //Do not try to reply to an ACK request.\n        if (request.method !== SIP.C.ACK) {\n          request.reply(500);\n        }\n\n        if (request.cseq === this.invite_seqnum) {\n          return true;\n        }\n\n        return false;\n      } else if (request.cseq > this.remote_seqnum) {\n        this.remote_seqnum = request.cseq;\n      }\n\n      switch (request.method) {\n        // RFC3261 14.2 Modifying an Existing Session -UAS BEHAVIOR-\n        case SIP.C.INVITE:\n          if (this.uac_pending_reply === true) {\n            request.reply(491);\n          } else if (this.uas_pending_reply === true) {\n            var retryAfter = (Math.random() * 10 | 0) + 1;\n            request.reply(500, null, ['Retry-After:' + retryAfter]);\n            return false;\n          } else {\n            this.uas_pending_reply = true;\n            request.server_transaction.on('stateChanged', function stateChanged() {\n              if (this.state === SIP.Transactions.C.STATUS_ACCEPTED || this.state === SIP.Transactions.C.STATUS_COMPLETED || this.state === SIP.Transactions.C.STATUS_TERMINATED) {\n                this.removeListener('stateChanged', stateChanged);\n                self.uas_pending_reply = false;\n\n                if (self.uac_pending_reply === false) {\n                  self.owner.onReadyToReinvite();\n                }\n              }\n            });\n          } // RFC3261 12.2.2 Replace the dialog`s remote target URI if the request is accepted\n\n\n          if (request.hasHeader('contact')) {\n            request.server_transaction.on('stateChanged', function () {\n              if (this.state === SIP.Transactions.C.STATUS_ACCEPTED) {\n                self.remote_target = request.parseHeader('contact').uri;\n              }\n            });\n          }\n\n          break;\n\n        case SIP.C.NOTIFY:\n          // RFC6665 3.2 Replace the dialog`s remote target URI if the request is accepted\n          if (request.hasHeader('contact')) {\n            request.server_transaction.on('stateChanged', function () {\n              if (this.state === SIP.Transactions.C.STATUS_COMPLETED) {\n                self.remote_target = request.parseHeader('contact').uri;\n              }\n            });\n          }\n\n          break;\n      }\n\n      return true;\n    },\n    sendRequest: function sendRequest(applicant, method, options) {\n      options = options || {};\n      var extraHeaders = (options.extraHeaders || []).slice();\n      var body = null;\n\n      if (options.body) {\n        if (options.body.body) {\n          body = options.body;\n        } else {\n          body = {};\n          body.body = options.body;\n\n          if (options.contentType) {\n            body.contentType = options.contentType;\n          }\n        }\n      }\n\n      var request = this.createRequest(method, extraHeaders, body),\n          request_sender = new RequestSender(this, applicant, request);\n      request_sender.send();\n      return request;\n    },\n\n    /**\n    * @param {SIP.IncomingRequest} request\n    */\n    receiveRequest: function receiveRequest(request) {\n      //Check in-dialog request\n      if (!this.checkInDialogRequest(request)) {\n        return;\n      }\n\n      this.owner.receiveRequest(request);\n    }\n  };\n  Dialog.C = C;\n  SIP.Dialog = Dialog;\n};","map":null,"metadata":{},"sourceType":"script"}