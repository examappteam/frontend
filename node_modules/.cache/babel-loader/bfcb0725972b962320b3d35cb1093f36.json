{"ast":null,"code":"\"use strict\";\n/**\n * @fileoverview SIP Digest Authentication\n */\n\n/**\n * SIP Digest Authentication.\n * @augments SIP.\n * @function Digest Authentication\n * @param {SIP.UA} ua\n */\n\nmodule.exports = function (Utils) {\n  var DigestAuthentication;\n\n  DigestAuthentication = function DigestAuthentication(ua) {\n    this.logger = ua.getLogger('sipjs.digestauthentication');\n    this.username = ua.configuration.authorizationUser;\n    this.password = ua.configuration.password;\n    this.cnonce = null;\n    this.nc = 0;\n    this.ncHex = '00000000';\n    this.response = null;\n  };\n  /**\n  * Performs Digest authentication given a SIP request and the challenge\n  * received in a response to that request.\n  * Returns true if credentials were successfully generated, false otherwise.\n  *\n  * @param {SIP.OutgoingRequest} request\n  * @param {Object} challenge\n  */\n\n\n  DigestAuthentication.prototype.authenticate = function (request, challenge) {\n    // Inspect and validate the challenge.\n    this.algorithm = challenge.algorithm;\n    this.realm = challenge.realm;\n    this.nonce = challenge.nonce;\n    this.opaque = challenge.opaque;\n    this.stale = challenge.stale;\n\n    if (this.algorithm) {\n      if (this.algorithm !== 'MD5') {\n        this.logger.warn('challenge with Digest algorithm different than \"MD5\", authentication aborted');\n        return false;\n      }\n    } else {\n      this.algorithm = 'MD5';\n    }\n\n    if (!this.realm) {\n      this.logger.warn('challenge without Digest realm, authentication aborted');\n      return false;\n    }\n\n    if (!this.nonce) {\n      this.logger.warn('challenge without Digest nonce, authentication aborted');\n      return false;\n    } // 'qop' can contain a list of values (Array). Let's choose just one.\n\n\n    if (challenge.qop) {\n      if (challenge.qop.indexOf('auth') > -1) {\n        this.qop = 'auth';\n      } else if (challenge.qop.indexOf('auth-int') > -1) {\n        this.qop = 'auth-int';\n      } else {\n        // Otherwise 'qop' is present but does not contain 'auth' or 'auth-int', so abort here.\n        this.logger.warn('challenge without Digest qop different than \"auth\" or \"auth-int\", authentication aborted');\n        return false;\n      }\n    } else {\n      this.qop = null;\n    } // Fill other attributes.\n\n\n    this.method = request.method;\n    this.uri = request.ruri;\n    this.cnonce = Utils.createRandomToken(12);\n    this.nc += 1;\n    this.updateNcHex(); // nc-value = 8LHEX. Max value = 'FFFFFFFF'.\n\n    if (this.nc === 4294967296) {\n      this.nc = 1;\n      this.ncHex = '00000001';\n    } // Calculate the Digest \"response\" value.\n\n\n    this.calculateResponse();\n    return true;\n  };\n  /**\n  * Generate Digest 'response' value.\n  * @private\n  */\n\n\n  DigestAuthentication.prototype.calculateResponse = function () {\n    var ha1, ha2; // HA1 = MD5(A1) = MD5(username:realm:password)\n\n    ha1 = Utils.calculateMD5(this.username + \":\" + this.realm + \":\" + this.password);\n\n    if (this.qop === 'auth') {\n      // HA2 = MD5(A2) = MD5(method:digestURI)\n      ha2 = Utils.calculateMD5(this.method + \":\" + this.uri); // response = MD5(HA1:nonce:nonceCount:credentialsNonce:qop:HA2)\n\n      this.response = Utils.calculateMD5(ha1 + \":\" + this.nonce + \":\" + this.ncHex + \":\" + this.cnonce + \":auth:\" + ha2);\n    } else if (this.qop === 'auth-int') {\n      // HA2 = MD5(A2) = MD5(method:digestURI:MD5(entityBody))\n      ha2 = Utils.calculateMD5(this.method + \":\" + this.uri + \":\" + Utils.calculateMD5(this.body ? this.body : \"\")); // response = MD5(HA1:nonce:nonceCount:credentialsNonce:qop:HA2)\n\n      this.response = Utils.calculateMD5(ha1 + \":\" + this.nonce + \":\" + this.ncHex + \":\" + this.cnonce + \":auth-int:\" + ha2);\n    } else if (this.qop === null) {\n      // HA2 = MD5(A2) = MD5(method:digestURI)\n      ha2 = Utils.calculateMD5(this.method + \":\" + this.uri); // response = MD5(HA1:nonce:HA2)\n\n      this.response = Utils.calculateMD5(ha1 + \":\" + this.nonce + \":\" + ha2);\n    }\n  };\n  /**\n  * Return the Proxy-Authorization or WWW-Authorization header value.\n  */\n\n\n  DigestAuthentication.prototype.toString = function () {\n    var auth_params = [];\n\n    if (!this.response) {\n      throw new Error('response field does not exist, cannot generate Authorization header');\n    }\n\n    auth_params.push('algorithm=' + this.algorithm);\n    auth_params.push('username=\"' + this.username + '\"');\n    auth_params.push('realm=\"' + this.realm + '\"');\n    auth_params.push('nonce=\"' + this.nonce + '\"');\n    auth_params.push('uri=\"' + this.uri + '\"');\n    auth_params.push('response=\"' + this.response + '\"');\n\n    if (this.opaque) {\n      auth_params.push('opaque=\"' + this.opaque + '\"');\n    }\n\n    if (this.qop) {\n      auth_params.push('qop=' + this.qop);\n      auth_params.push('cnonce=\"' + this.cnonce + '\"');\n      auth_params.push('nc=' + this.ncHex);\n    }\n\n    return 'Digest ' + auth_params.join(', ');\n  };\n  /**\n  * Generate the 'nc' value as required by Digest in this.ncHex by reading this.nc.\n  * @private\n  */\n\n\n  DigestAuthentication.prototype.updateNcHex = function () {\n    var hex = Number(this.nc).toString(16);\n    this.ncHex = '00000000'.substr(0, 8 - hex.length) + hex;\n  };\n\n  return DigestAuthentication;\n};","map":null,"metadata":{},"sourceType":"script"}