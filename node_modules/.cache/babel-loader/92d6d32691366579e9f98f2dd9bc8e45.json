{"ast":null,"code":"var localMinSE = 90;\n\nmodule.exports = function (Timers) {\n  // http://tools.ietf.org/html/rfc4028#section-9\n  function hasSmallMinSE(message) {\n    var supportedOptions = message.parseHeader('Supported') || [];\n    var sessionExpires = message.parseHeader('Session-Expires') || {};\n    return supportedOptions.indexOf('timer') >= 0 && sessionExpires.deltaSeconds < localMinSE;\n  } // `response` is an IncomingResponse or a String (outgoing response)\n\n\n  function updateState(dialog, response, parseMessage, ua) {\n    dialog.sessionTimerState = dialog.sessionTimerState || {};\n    Timers.clearTimeout(dialog.sessionTimerState.timeout);\n    var isUAS = typeof response === 'string';\n\n    if (isUAS) {\n      response = parseMessage(response, ua);\n    }\n\n    var sessionExpires = response.parseHeader('Session-Expires'); // If the most recent 2xx response had no Session-Expires header field, there\n    // is no session expiration, and no refreshes have to be performed\n\n    if (!sessionExpires) {\n      dialog.sessionTimerState = null;\n      return;\n    }\n\n    var interval = sessionExpires.deltaSeconds;\n    var isRefresher = isUAS === (sessionExpires.refresher === 'uas');\n    dialog.sessionTimerState = {\n      interval: interval,\n      isRefresher: isRefresher\n    };\n    var intervalMilliseconds = interval * 1000;\n    var self = this;\n\n    if (isRefresher) {\n      dialog.sessionTimerState.timeout = Timers.setInterval(function sendRefresh() {\n        var exists = dialog.owner.ua.dialogs[dialog.id.toString()] || false;\n\n        if (exists) {\n          dialog.sendRequest(self, \"UPDATE\", {\n            extraHeaders: [\"Session-Expires: \" + interval]\n          });\n        } else {\n          Timers.clearInterval(dialog.sessionTimerState.timeout);\n        }\n      }, intervalMilliseconds / 2);\n    } else {\n      var before = Math.min(32 * 1000, intervalMilliseconds / 3);\n      dialog.sessionTimerState.timeout = Timers.setTimeout(function sendBye() {// TODO\n      }, intervalMilliseconds - before);\n    }\n  }\n\n  function receiveResponse(response) {\n    /* jshint unused: false */\n  }\n\n  function onDialogError(response) {\n    /* jshint unused: false */\n  }\n\n  function onRequestTimeout() {\n    /* jshint unused: false */\n  }\n\n  function onTransportError() {\n    /* jshint unused: false */\n  }\n\n  return {\n    localMinSE: localMinSE,\n    hasSmallMinSE: hasSmallMinSE,\n    updateState: updateState,\n    receiveResponse: receiveResponse,\n    onDialogError: onDialogError,\n    onRequestTimeout: onRequestTimeout,\n    onTransportError: onTransportError\n  };\n};","map":null,"metadata":{},"sourceType":"script"}