{"ast":null,"code":"\"use strict\";\n/**\n * @fileoverview Incoming SIP Message Sanity Check\n */\n\n/**\n * SIP message sanity check.\n * @augments SIP\n * @function\n * @param {SIP.IncomingMessage} message\n * @param {SIP.UA} ua\n * @param {SIP.Transport} transport\n * @returns {Boolean}\n */\n\nmodule.exports = function (SIP) {\n  var sanityCheck,\n      requests = [],\n      responses = [],\n      all = []; // Reply\n\n  function reply(status_code, message, transport) {\n    var to,\n        response = SIP.Utils.buildStatusLine(status_code),\n        vias = message.getHeaders('via'),\n        length = vias.length,\n        idx = 0;\n\n    for (idx; idx < length; idx++) {\n      response += \"Via: \" + vias[idx] + \"\\r\\n\";\n    }\n\n    to = message.getHeader('To');\n\n    if (!message.to_tag) {\n      to += ';tag=' + SIP.Utils.newTag();\n    }\n\n    response += \"To: \" + to + \"\\r\\n\";\n    response += \"From: \" + message.getHeader('From') + \"\\r\\n\";\n    response += \"Call-ID: \" + message.call_id + \"\\r\\n\";\n    response += \"CSeq: \" + message.cseq + \" \" + message.method + \"\\r\\n\";\n    response += \"\\r\\n\";\n    transport.send(response);\n  }\n  /*\n   * Sanity Check for incoming Messages\n   *\n   * Requests:\n   *  - _rfc3261_8_2_2_1_ Receive a Request with a non supported URI scheme\n   *  - _rfc3261_16_3_4_ Receive a Request already sent by us\n   *   Does not look at via sent-by but at sipjsId, which is inserted as\n   *   a prefix in all initial requests generated by the ua\n   *  - _rfc3261_18_3_request_ Body Content-Length\n   *  - _rfc3261_8_2_2_2_ Merged Requests\n   *\n   * Responses:\n   *  - _rfc3261_8_1_3_3_ Multiple Via headers\n   *  - _rfc3261_18_1_2_ sent-by mismatch\n   *  - _rfc3261_18_3_response_ Body Content-Length\n   *\n   * All:\n   *  - Minimum headers in a SIP message\n   */\n  // Sanity Check functions for requests\n\n\n  function rfc3261_8_2_2_1(message, ua, transport) {\n    if (!message.ruri || message.ruri.scheme !== 'sip') {\n      reply(416, message, transport);\n      return false;\n    }\n  }\n\n  function rfc3261_16_3_4(message, ua, transport) {\n    if (!message.to_tag) {\n      if (message.call_id.substr(0, 5) === ua.configuration.sipjsId) {\n        reply(482, message, transport);\n        return false;\n      }\n    }\n  }\n\n  function rfc3261_18_3_request(message, ua, transport) {\n    var len = SIP.Utils.str_utf8_length(message.body),\n        contentLength = message.getHeader('content-length');\n\n    if (len < contentLength) {\n      reply(400, message, transport);\n      return false;\n    }\n  }\n\n  function rfc3261_8_2_2_2(message, ua, transport) {\n    var tr,\n        idx,\n        fromTag = message.from_tag,\n        call_id = message.call_id,\n        cseq = message.cseq;\n\n    if (!message.to_tag) {\n      if (message.method === SIP.C.INVITE) {\n        tr = ua.transactions.ist[message.via_branch];\n\n        if (tr) {\n          return;\n        } else {\n          for (idx in ua.transactions.ist) {\n            tr = ua.transactions.ist[idx];\n\n            if (tr.request.from_tag === fromTag && tr.request.call_id === call_id && tr.request.cseq === cseq) {\n              reply(482, message, transport);\n              return false;\n            }\n          }\n        }\n      } else {\n        tr = ua.transactions.nist[message.via_branch];\n\n        if (tr) {\n          return;\n        } else {\n          for (idx in ua.transactions.nist) {\n            tr = ua.transactions.nist[idx];\n\n            if (tr.request.from_tag === fromTag && tr.request.call_id === call_id && tr.request.cseq === cseq) {\n              reply(482, message, transport);\n              return false;\n            }\n          }\n        }\n      }\n    }\n  } // Sanity Check functions for responses\n\n\n  function rfc3261_8_1_3_3(message, ua) {\n    if (message.getHeaders('via').length > 1) {\n      ua.getLogger('sip.sanitycheck').warn('More than one Via header field present in the response. Dropping the response');\n      return false;\n    }\n  }\n\n  function rfc3261_18_3_response(message, ua) {\n    var len = SIP.Utils.str_utf8_length(message.body),\n        contentLength = message.getHeader('content-length');\n\n    if (len < contentLength) {\n      ua.getLogger('sip.sanitycheck').warn('Message body length is lower than the value in Content-Length header field. Dropping the response');\n      return false;\n    }\n  } // Sanity Check functions for requests and responses\n\n\n  function minimumHeaders(message, ua) {\n    var mandatoryHeaders = ['from', 'to', 'call_id', 'cseq', 'via'],\n        idx = mandatoryHeaders.length;\n\n    while (idx--) {\n      if (!message.hasHeader(mandatoryHeaders[idx])) {\n        ua.getLogger('sip.sanitycheck').warn('Missing mandatory header field : ' + mandatoryHeaders[idx] + '. Dropping the response');\n        return false;\n      }\n    }\n  }\n\n  requests.push(rfc3261_8_2_2_1);\n  requests.push(rfc3261_16_3_4);\n  requests.push(rfc3261_18_3_request);\n  requests.push(rfc3261_8_2_2_2);\n  responses.push(rfc3261_8_1_3_3); // responses.push(rfc3261_18_1_2);\n\n  responses.push(rfc3261_18_3_response);\n  all.push(minimumHeaders);\n\n  sanityCheck = function sanityCheck(message, ua, transport) {\n    var len, pass;\n    len = all.length;\n\n    while (len--) {\n      pass = all[len](message, ua, transport);\n\n      if (pass === false) {\n        return false;\n      }\n    }\n\n    if (message instanceof SIP.IncomingRequest) {\n      len = requests.length;\n\n      while (len--) {\n        pass = requests[len](message, ua, transport);\n\n        if (pass === false) {\n          return false;\n        }\n      }\n    } else if (message instanceof SIP.IncomingResponse) {\n      len = responses.length;\n\n      while (len--) {\n        pass = responses[len](message, ua, transport);\n\n        if (pass === false) {\n          return false;\n        }\n      }\n    } //Everything is OK\n\n\n    return true;\n  };\n\n  SIP.sanityCheck = sanityCheck;\n};","map":null,"metadata":{},"sourceType":"script"}